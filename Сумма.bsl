////////////////////////////////////////////////////////////////////////////////
// Порционная запись движений
// Обеспечивает перенос движений документов по частям для улучшения производительности
////////////////////////////////////////////////////////////////////////////////

#Область ОписаниеПеременных

// Переменные модуля
Перем ИспользуемыйРегистрХозрасчетный;
Перем ИспользуемыйРегистрМеждународный;
Перем СобытиеЖурналаРегистрации;
Перем ПолучитьКлючПроцедуры;

#КонецОбласти

#Область ПрограммныйИнтерфейс

// Запускает фоновое задание для порционного переноса движений документов
//
// Возвращаемое значение:
//   Булево - результат выполнения операции
//
Процедура СтартПереносаДвижений() Экспорт
    
    ОтборФоновых = Новый Структура("ИмяМетода, Состояние", 
        "озПорционнаяЗаписьДвижений.ПеренестиДвижения", 
        СостояниеФоновогоЗадания.Активно);
    
    // Проверяем существование активного фонового задания
    Если Не озОбщегоНазначенияВызовСервера.ФоновоеЗаданиеСуществует(ОтборФоновых) Тогда
        Ключ = ПолучитьКлючПроцедуры();
        Наименование = СтрШаблон("%1 №%2 Дата запуска:%3", Ключ, ТекущаяДата());
        Параметры = Новый Массив;
        
        НовоеЗадание = ФоновыеЗадания.Выполнить(
            "озПорционнаяЗаписьДвижений.ПеренестиДвижения", 
            Параметры, 
            Наименование, 
            Ключ
        );
    КонецЕсли;
    
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытий

// Обработчик события перед записью набора записей регистра
//
// Параметры:
//   Набор - РегистрБухгалтерииНаборЗаписей - набор записей регистра
//   Отказ - Булево - признак отказа от записи
//   ВыполнятьОбработчик - Булево - признак выполнения обработчика
//
Процедура ПередЗаписьюНабора(Набор, Отказ, ВыполнятьОбработчик = Истина) Экспорт
    
    Если Отказ Тогда
        Возврат;
    КонецЕсли;
    
    Если Набор.ОбменДанными.Загрузка Тогда
        Возврат;
    КонецЕсли;      
    
    Регистратор = Набор.Отбор.Регистратор.Значение;
    
    Если ЭтоПодчиненныйДокумент(Регистратор) Тогда
        Если Не Набор.ДополнительныеСвойства.Свойство(ПолучитьКлючПроцедуры()) Тогда  
            Отказ = Истина;
            ОбщегоНазначения.СообщитьОбОшибке(
                СтрШаблон(
                    "Редактирование движений подчиненного регистратор доступно только из процедуры %1",  
                    СобытиеЖурналаРегистрации()
                )
            );
        Иначе
            ВыполнятьОбработчик = Ложь;
        КонецЕсли;
    КонецЕсли;
    
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Выполняет перенос движений документов в фоновом режиме
//
Процедура ПеренестиДвижения() Экспорт
    
    МаксПроходов = 600; // Примерно 30 минут для очистки памяти
    Счетчик = 0;
    
    Пока Истина Цикл
        Настройки = ПолучитьНастройки();
        СтартПолученияДанных = ТекущаяУниверсальнаяДатаВМиллисекундах();
        ДанныеПереноса = ПолучитьДанныеПереноса(Настройки); 
        
        Если ДанныеПереноса <> Неопределено Тогда  
            ЗаписьЖурналаРегистрации(
                СобытиеЖурналаРегистрации(), 
                УровеньЖурналаРегистрации.Информация, 
                , ,
                СтрШаблон(
                    "Процедура получила данные переноса за %1 сек.", 
                    ПолучитьДлительностьВСекундах(СтартПолученияДанных)
                )
            );
            
            ВыполнитьПереносПроводок(ДанныеПереноса, СтартПолученияДанных, Настройки);  
            ДанныеПереноса = Неопределено;  
            Счетчик = 0;
        КонецЕсли; 
        
        Если Настройки.РаботаВРежимеСервиса <> Истина Тогда
            Прервать;
        КонецЕсли;
        
        ОбщегоНазначенияБТС.Пауза(3);
        Счетчик = Счетчик + 1;
        
        Если Счетчик % 20 = 0 Тогда
            ЗаписьЖурналаРегистрации(
                СобытиеЖурналаРегистрации(), 
                УровеньЖурналаРегистрации.Информация, 
                , ,
                "Процедура ожидает данные переноса"
            );
        КонецЕсли;
        
        Если Счетчик > МаксПроходов Тогда
            Прервать;
        КонецЕсли;
    КонецЦикла;
    
КонецПроцедуры

// Возвращает настройки по умолчанию
//
// Возвращаемое значение:
//   Структура - настройки системы
//
Функция ПолучитьНастройкиПоУмолчанию() Экспорт
    
    Настройки = Новый Структура();
    Настройки.Вставить("ИспользоватьПорции", Ложь);
    Настройки.Вставить("РаботаВРежимеСервиса", Истина);	         
    Настройки.Вставить("КоличествоПараллельноОбрабатываемыхДокументов", 1);	 
    Настройки.Вставить("КоличествоПотоков", 10);
    Настройки.Вставить("РазмерПорции", 10000);
    Настройки.Вставить("КоличествоПорцийДляОдногоПотока", 1); 	
    Настройки.Вставить("МаксимальныйРазмерНабораЗаписи", 10000);  
    
    // {{OZON Зарубин И.Н. 13.06.24 ONEC- начало
    Настройки.Вставить("ирНачислениеРасходовМеждународный_ВКЛ", Истина); 
    // }}OZON Зарубин И.Н. 13.06.24 ONEC- окончание
    
    Возврат Настройки;
    
КонецФункции

// Возвращает настройки из справочника
//
// Возвращаемое значение:
//   Структура - настройки системы
//
Функция ПолучитьНастройки() Экспорт
    
    Настройки = ПолучитьНастройкиПоУмолчанию();
    Запрос = Новый Запрос(
        "ВЫБРАТЬ РАЗРЕШЕННЫЕ
        |	ВЫРАЗИТЬ(Т1.Свойство КАК СТРОКА) КАК Свойство,
        |	ВЫБОР
        |		КОГДА ТИПЗНАЧЕНИЯ(Т1.Значение) = ТИП(ЧИСЛО)
        |			ТОГДА ВЫРАЗИТЬ(Т1.Значение КАК ЧИСЛО)
        |		КОГДА ТИПЗНАЧЕНИЯ(Т1.Значение) = ТИП(БУЛЕВО)
        |			ТОГДА ВЫРАЗИТЬ(Т1.Значение КАК БУЛЕВО)
        |	КОНЕЦ КАК Значение
        |ИЗ
        |	Справочник.OZON_ПредопределенныеЗначения.ТабличнаяЧасть КАК Т1
        |ГДЕ
        |	Т1.Ссылка = ЗНАЧЕНИЕ(Справочник.OZON_ПредопределенныеЗначения.НастройкиПорционногоПроведенияДокументов)"
    );
    
    Запрос.УстановитьПараметр("Наименование", "НастройкиПорционногоПроведенияДокументов");
    Результат = Запрос.Выполнить();
    
    Если Не Результат.Пустой() Тогда
        Выборка = Результат.Выбрать();
        Пока Выборка.Следующий() Цикл
            Если Настройки.Свойство(Выборка.Свойство) Тогда
                Настройки[Выборка.Свойство] = Выборка.Значение;
            КонецЕсли;
        КонецЦикла;
    КонецЕсли;
    
    Возврат Настройки;
    
КонецФункции

// Выполняет перенос проводок
//
// Параметры:
//   ДанныеПереноса - Структура - данные для переноса
//   Старт - Число - время начала операции
//   Настройки - Структура - настройки системы
//
Процедура ВыполнитьПереносПроводок(ДанныеПереноса, Старт, Настройки)
    
    РазмерПорции = Настройки.РазмерПорции; 
    КоличествоПорцийДляОдногоПотока = Настройки.КоличествоПорцийДляОдногоПотока;
    КоличествоПотоков = Настройки.КоличествоПотоков;
    
    ДвиженияХозрасчетный = ДанныеПереноса.ДвиженияХозрасчетный;
    ДвиженияМСФО =  ДанныеПереноса.ДвиженияМСФО;
    СписокРегистраторов =  ДанныеПереноса.СписокРегистраторов;
    ДокументыПереноса =  ДанныеПереноса.ДокументыПереноса;
    
    // Формирование заданий записи наборов
    ДополнительныеПараметрыПорций = Новый Структура("ИмяРегистра", "Хозрасчетный");
    ПорцииДанныхЗаписиРегистров = ПолучитьПорцииДанных(ДвиженияХозрасчетный, РазмерПорции, "Регистратор,Период",,ДополнительныеПараметрыПорций);  	
    
    ДополнительныеПараметрыПорций = Новый Структура("ИмяРегистра", "Международный");	
    ПорцииДанныхЗаписиРегистров = ПолучитьПорцииДанных(ДвиженияМСФО, РазмерПорции, "Регистратор,Период",ПорцииДанныхЗаписиРегистров, ДополнительныеПараметрыПорций);  
    
    Для Каждого Порция ИЗ ПорцииДанныхЗаписиРегистров Цикл   
        ПодчиненныйРегистратор = ПолучитьПодчиненныйРегистратор(Порция.Ключ.Регистратор, СписокРегистраторов);
        Порция.Ключ.Вставить("ПодчиненныйРегистратор", ПодчиненныйРегистратор);
    КонецЦикла;    
    
    ПорцииИсполненияЗаписиНаборов =  КомпоновкаПорций(ПорцииДанныхЗаписиРегистров, КоличествоПорцийДляОдногоПотока, "озПорционнаяЗаписьДвижений.ЗаполнениеНаборов");
    
    // Формирование заданий очистки наборов 	
    ТаблицаНеИспользуемыеДокументы = СписокРегистраторов.Скопировать(СписокРегистраторов.НайтиСтроки(Новый Структура("Использован", Ложь))); 
    ПорцииДанныхОчисткаНаборов = ПолучитьПорцииДанных(ТаблицаНеИспользуемыеДокументы, КоличествоПорцийДляОдногоПотока);
    ПорцииИсполненияОчисткаНаборов = КомпоновкаПорций(ПорцииДанныхОчисткаНаборов, КоличествоПорцийДляОдногоПотока, "озПорционнаяЗаписьДвижений.ОчисткаНаборов");
    
    // Запуск заданий  
    ОбщегоНазначенияКлиентСервер.ДополнитьМассив(ПорцииИсполненияЗаписиНаборов, ПорцииИсполненияОчисткаНаборов);
    ОшибкиФоновыхЗаданий = Новый Массив;
    ДанныеПереноса = Неопределено;
    
    ЗапуститьЗадания(ПорцииИсполненияЗаписиНаборов, КоличествоПотоков, ОшибкиФоновыхЗаданий); 
    
    КонтрольВыполнения(ДокументыПереноса, СписокРегистраторов);
    
    Если ОшибкиФоновыхЗаданий.Количество() Тогда
        ПодробноеПредставлениеОшибки = СтрСоединить(ОшибкиФоновыхЗаданий, Символы.ПС);
        ЗаписьЖурналаРегистрации(СобытиеЖурналаРегистрации(), УровеньЖурналаРегистрации.Ошибка, , , ПодробноеПредставлениеОшибки);
        ВызватьИсключение  ПодробноеПредставлениеОшибки;
    КонецЕсли; 
    
    СписокДокументов = СтрСоединить(ДокументыПереноса.ВыгрузитьКолонку("Документ"), Символы.ПС);	
    Комментарий = СтрШаблон(
        "Окончание процедуры порционная запись движений Длительность:%1 Список документов:%2", 
        ПолучитьДлительностьВСекундах(Старт), 
        СписокДокументов
    );
    
    ЗаписьЖурналаРегистрации(СобытиеЖурналаРегистрации(), УровеньЖурналаРегистрации.Информация, , ,Комментарий);
    
КонецПроцедуры

// Получает длительность выполнения в секундах
//
// Параметры:
//   СтартВМиллисекундах - Число - время начала операции
//
// Возвращаемое значение:
//   Число - продолжительность в секундах
//
Функция ПолучитьДлительностьВСекундах(СтартВМиллисекундах)
    Возврат Окр((ТекущаяУниверсальнаяДатаВМиллисекундах() - СтартВМиллисекундах)/1000, 2);
КонецФункции

// Контроль выполнения операций
//
// Параметры:
//   ДокументыПереноса - Массив - документы для переноса
//   СписокРегистраторов - ТаблицаЗначений - список регистраторов
//
Процедура КонтрольВыполнения(ДокументыПереноса, СписокРегистраторов)
    
    Для Каждого СтрокаГлавногоДокумента ИЗ  ДокументыПереноса Цикл
        СтрокиПодчиненныхРегистраторов = СписокРегистраторов.НайтиСтроки(Новый Структура("ГлавныйДокумент", СтрокаГ